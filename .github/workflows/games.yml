name: Lichess Bot Stats

on:
  workflow_dispatch: # run manually from GitHub Actions tab

jobs:
  stats:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run Bot Stats
        run: |
          #!/bin/bash
          BOTS=("AttackKing_Bot" "ToromBot" "Endogenetic-Bot" "NNUE_Drift" "MaggiChess16" "NimsiluBot")

          for BOT in "${BOTS[@]}"; do
              echo "Processing $BOT..."
              JSON_FILE="${BOT}.json"
              rm -f "$JSON_FILE"

              UNTIL=""
              while :; do
                  RESPONSE=$(curl -s -L "https://lichess.org/api/games/user/${BOT}" \
                      -G \
                      --data-urlencode "max=5000" \
                      ${UNTIL:+--data-urlencode "until=$UNTIL"} \
                      -H "Accept: application/x-ndjson")

                  if [ -z "$RESPONSE" ]; then
                      break
                  fi

                  echo "$RESPONSE" >> "$JSON_FILE"

                  UNTIL=$(echo "$RESPONSE" | jq -r '.[-1].createdAt // empty')
                  if [ -z "$UNTIL" ]; then
                      break
                  fi
              done

              if [ ! -s "$JSON_FILE" ]; then
                  echo "No games found for $BOT"
                  continue
              fi

              WINS=$(jq -r --arg BOT "$BOT" 'select(.winner == "white" and .players.white.user.name == $BOT) or
                                              (.winner == "black" and .players.black.user.name == $BOT) | .id' "$JSON_FILE" | wc -l)
              DRAWS=$(jq -r --arg BOT "$BOT" 'select(.status == "draw" and
                                              ((.players.white.user.name == $BOT) or (.players.black.user.name == $BOT))) | .id' "$JSON_FILE" | wc -l)

              echo "$BOT: Wins=$WINS, Draws=$DRAWS, Total=$((WINS + DRAWS))"
          done
